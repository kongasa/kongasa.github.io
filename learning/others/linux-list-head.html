<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta http-equiv="refresh" content="600"><title>Linux list_head | Kongasa</title><meta name="description" content="Kongasa's blog."><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.12">
    <link rel="preload" href="/assets/js/runtime~app.87b0993d.js" as="script"><link rel="preload" href="/assets/css/styles.9d59134f.css" as="style"><link rel="preload" href="/assets/js/772.9e44fbb3.js" as="script"><link rel="preload" href="/assets/js/app.d9c0abc2.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.9d59134f.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button"><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class=""></path></svg></div><span><a href="/" class=""><img class="logo" src="/images/logo.png" alt="Kongasa"><span class="site-name can-hide">Kongasa</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/" class="nav-link" aria-label="Home"><!--[--><!--]--> Home <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/learning/" class="nav-link router-link-active" aria-label="Learning"><!--[--><!--]--> Learning <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/kongasa/kongasa.github.io" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><!----></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/" class="nav-link" aria-label="Home"><!--[--><!--]--> Home <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/learning/" class="nav-link router-link-active" aria-label="Learning"><!--[--><!--]--> Learning <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/kongasa/kongasa.github.io" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><section class="sidebar-group"><p class="sidebar-heading">Linux list_head</p><!----></section><!--]--><!--]--></ul><!--[--><!--]--></aside><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="linux-list-head"><a class="header-anchor" href="#linux-list-head">#</a> Linux list_head</h1><p>参考：</p><p><a href="https://www.cnblogs.com/zhuyp1015/archive/2012/06/02/2532240.html" target="_blank" rel="noopener noreferrer">Linux 内核list_head 学习（一）<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p><p><a href="https://www.zhihu.com/question/49164544/answer/301969545" target="_blank" rel="noopener noreferrer">C 语言中，「.」与「-&gt;」有什么区别？<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p><p>Linux 的链表很有意思。</p><p>linux 的链表只包含两个指针，是一个双向循环有头节点的链表结构。它不包含其他数据结构，其他数据结构包含它，头节点不被包含。</p><p>给出链表节点地址，节点数据类型，链表数据类型（对于链表永远是 <code>list_head</code>，但是这个宏是通用的），就可以得到包含列表的节点的地址。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">offsetof</span><span class="token expression"><span class="token punctuation">(</span>TYPE<span class="token punctuation">,</span>MEMBER<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>TYPE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>MEMBER<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">container_of</span><span class="token expression"><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span>type<span class="token punctuation">,</span>member<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token operator">-</span><span class="token function">offsetof</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span>member<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>offsetof</code> 的设计非常精妙。它相当于是程序员向编译器发问，「假如， MEMBER 所属的对象地址在 0，那你应该能帮我拿到 MEMBER 吧？我知道你不会真的去访问内存，引起中断，导致崩溃。把它的地址给我就行。」</p><p>因为对象从 0 地址开始，offsetof 返回的值就是 MEMBER 的偏移量。</p><p><code>container_of</code> 故技重施，是 <code>offsetof</code> 的反向操作。</p><p>关于为什么 <code>((TYPE*) 0)-&gt;MEMBER</code> 不会发生内存访问。请看</p><p><a href="https://www.zhihu.com/question/49164544/answer/301969545" target="_blank" rel="noopener noreferrer">C 语言中，「.」与「-&gt;」有什么区别？<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p><p>使用 <code>.</code> 的表达式（一个变量也是表达式，而且 <code>a.b</code> 不是变量，因为 <code>.</code> 是个操作符 ）是左值还是右值取决于 <code>.</code> 的左操作数，而使用 <code>-&gt;</code> 的表达式将永远是个左值。访问地址是运行时发生的，但是因为这个宏并没有用到地址上的数据，编译后的机器码并不会发生内存访问，也就不会发生中断。改一改编译器的话，这个宏就可能出问题。</p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">2021/5/6 上午7:23:08</span></div><!----></footer><!----><!--[--><!--]--></main></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.87b0993d.js" defer></script><script src="/assets/js/772.9e44fbb3.js" defer></script><script src="/assets/js/app.d9c0abc2.js" defer></script>
  </body>
</html>
